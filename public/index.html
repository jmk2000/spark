<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPARK - Server Power Automated Remote Kontrol</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 40px; color: white; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .header .subtitle { font-size: 1.1rem; opacity: 0.9; margin-bottom: 5px; }
        .header .acronym { font-size: 0.9rem; opacity: 0.8; font-style: italic; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .card { background: rgba(255, 255, 255, 0.9); border-radius: 12px; padding: 25px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0,0,0,0.15); }
        .card-title { font-size: 1.4rem; font-weight: 600; margin-bottom: 15px; color: #2d3748; display: flex; align-items: center; gap: 10px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; animation: pulse 2s infinite; }
        .status-online { background-color: #48bb78; }
        .status-offline { background-color: #f56565; }
        .button { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; margin: 5px; box-shadow: 0 4px 14px rgba(0,0,0,0.1); }
        .button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .button:active { transform: translateY(0); }
        .button.danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0; }
        .info-item { background: #f7fafc; padding: 12px; border-radius: 6px; border-left: 4px solid #4f46e5; }
        .info-label { font-size: 0.85rem; color: #718096; margin-bottom: 4px; }
        .info-value { font-size: 1.1rem; font-weight: 600; color: #2d3748; word-break: break-all; }
        .service-status { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e2e8f0; }
        .service-status:last-child { border-bottom: none; }
        .service-name { font-weight: 500; }
        .service-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .badge-online { background-color: #c6f6d5; color: #22543d; }
        .badge-offline { background-color: #fed7d7; color: #742a2a; }
        .performance-bar { background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .performance-fill { height: 100%; transition: width 0.5s ease; border-radius: 4px; }
        .performance-cpu { background: linear-gradient(90deg, #4ade80, #22c55e); }
        .performance-memory { background: linear-gradient(90deg, #60a5fa, #3b82f6); }
        .performance-disk { background: linear-gradient(90deg, #a78bfa, #8b5cf6); }
        .performance-gpu { background: linear-gradient(90deg, #81e6d9, #38b2ac); }
        .logs-container { background: #1a202c; color: #e2e8f0; padding: 20px; border-radius: 8px; font-family: 'Monaco', 'Menlo', monospace; font-size: 0.9rem; max-height: 300px; overflow-y: auto; margin-top: 15px; }
        .full-width { grid-column: 1 / -1; }
        .config-item { padding: 10px 0; border-bottom: 1px solid #e2e8f0; }
        .config-item:last-child { border-bottom: none; }
        .config-label { display: flex; justify-content: space-between; align-items: center; font-weight: 500; cursor: pointer; }
        .sub-config { margin-left: 20px; margin-top: 10px; border-left: 2px solid #cbd5e0; padding-left: 15px; }
        .hidden { display: none; }
        .slider-container { display: flex; align-items: center; gap: 15px; margin-top: 8px; }
        input[type="range"] { flex-grow: 1; cursor: pointer; }
        #timeoutValue { font-weight: 600; min-width: 90px; text-align: right; }
        .countdown-text { text-align: center; font-weight: 600; color: #48bb78; margin-top: 10px; font-size: 1.1rem; }
        #actionMessage { margin-top: 15px; padding: 10px; border-radius: 6px; display: none; text-align: center; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° SPARK</h1>
            <p class="subtitle">Server Power Automated Remote Kontrol</p>
            <p class="acronym">Monitor and control your server's power state</p>
        </div>
        <div class="grid">
            <div class="card">
                <div class="card-title"><span class="status-indicator" id="statusIndicator"></span>Server Status</div>
                <div class="info-grid">
                    <div class="info-item"><div class="info-label">Status</div><div class="info-value" id="serverStatus">Checking...</div></div>
                    <div class="info-item"><div class="info-label">Last Seen</div><div class="info-value" id="lastSeen">-</div></div>
                    <div class="info-item"><div class="info-label">Response Time</div><div class="info-value" id="responseTime">-</div></div>
                    <div class="info-item"><div class="info-label">Server IP</div><div class="info-value" id="serverIP">-</div></div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">‚ö° Power Controls</div>
                <div style="text-align: center;">
                    <button class="button" id="wakeBtn" onclick="wakeServer()">Wake Server</button>
                    <button class="button danger" id="sleepBtn" onclick="sleepServer()">Sleep Server</button>
                    <button class="button" onclick="refreshStatus()">Refresh Status</button>
                </div>
                <div id="actionMessage"></div>
            </div>
            <div class="card">
                <div class="card-title">üîå Idle Shutdown</div>
                <div class="config-item"><label class="config-label" for="idleEnableCheckbox"><span>Enable Idle Shutdown</span><input type="checkbox" id="idleEnableCheckbox"></label></div>
                <div id="idleOptionsContainer" class="hidden">
                    <div class="config-item sub-config"><label class="config-label" for="gpuEnableCheckbox"><span>Include GPU Utilization</span><input type="checkbox" id="gpuEnableCheckbox"></label></div>
                    <div class="config-item sub-config">
                        <div class="config-label"><span>Idle Duration (Requests)</span></div>
                        <div class="slider-container"><input type="range" id="timeoutSlider" min="5" max="60" step="5" value="15"><span id="timeoutValue">15 minutes</span></div>
                    </div>
                </div>
                <div id="idleCountdownContainer" class="countdown-text" style="display: none;"></div>
            </div>
            <div class="card">
                <div class="card-title">üîß Services Status</div>
                <div id="servicesStatus">
                    <div class="service-status"><span class="service-name">Ping</span><span class="service-badge" id="pingStatus">Unknown</span></div>
                    <div class="service-status"><span class="service-name">SSH</span><span class="service-badge" id="sshStatus">Unknown</span></div>
                    <div class="service-status"><span class="service-name">Target Port</span><span class="service-badge" id="httpStatus">Unknown</span></div>
                    <div class="service-status"><span class="service-name">Target HTTP Service</span><span class="service-badge" id="targetHttpStatus">Unknown</span></div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">üìä Performance Metrics</div>
                <div id="performanceMetrics">
                    <div class="info-item"><div class="info-label">CPU</div><div class="info-value" id="cpuUsage">N/A</div><div class="performance-bar"><div class="performance-fill performance-cpu" id="cpuBar"></div></div></div>
                    <div class="info-item"><div class="info-label">Memory</div><div class="info-value" id="memoryUsage">N/A</div><div class="performance-bar"><div class="performance-fill performance-memory" id="memoryBar"></div></div></div>
                    <div class="info-item"><div class="info-label">Disk</div><div class="info-value" id="diskUsage">N/A</div><div class="performance-bar"><div class="performance-fill performance-disk" id="diskBar"></div></div></div>
                    <div class="info-item"><div class="info-label">GPU</div><div class="info-value" id="gpuUsage">N/A</div><div class="performance-bar"><div class="performance-fill performance-gpu" id="gpuBar"></div></div></div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">‚öôÔ∏è SPARK Configuration</div>
                <div class="info-grid">
                    <div class="info-item"><div class="info-label">Target IP</div><div class="info-value" id="configIP">...</div></div>
                    <div class="info-item"><div class="info-label">MAC Address</div><div class="info-value" id="configMAC">...</div></div>
                    <div class="info-item"><div class="info-label">SSH Port</div><div class="info-value" id="configSSH">...</div></div>
                    <div class="info-item"><div class="info-label">HTTP Port</div><div class="info-value" id="configHTTP">...</div></div>
                </div>
            </div>
            <div class="card full-width">
                <div class="card-title">üìã System Logs</div>
                <div class="logs-container" id="logsContainer"><div class="log-entry">Initializing...</div></div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const API_BASE_URL = window.location.origin;

        document.addEventListener('DOMContentLoaded', initializeApp);

        async function initializeApp() {
            addLog('info', 'Initializing SPARK interface...');
            await loadInitialConfig();
            setupEventListeners();
            setupSocketListeners();
            refreshStatus();
        }

        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Invalid JSON response from server' }));
                    throw new Error(errorData.message || `Request failed with status ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`API call to ${endpoint} failed:`, error);
                showActionMessage(`Error: ${error.message}`, 'error');
                addLog('error', `API call to ${endpoint} failed: ${error.message}`);
                throw error;
            }
        }

        async function wakeServer() {
            showActionMessage('Sending wake command...', 'info');
            try {
                const result = await apiCall('/api/wake', { method: 'POST' });
                showActionMessage(result.message, result.success ? 'success' : 'error');
                setTimeout(refreshStatus, 5000);
            } catch (e) {}
        }

        async function sleepServer() {
            showActionMessage('Sending sleep command...', 'info');
            try {
                const result = await apiCall('/api/sleep', { method: 'POST' });
                showActionMessage(result.message, result.success ? 'success' : 'error');
                setTimeout(refreshStatus, 5000);
            } catch(e) {}
        }

        async function refreshStatus() {
            addLog('info', 'Refreshing server status...');
            try {
                const status = await apiCall('/api/status');
                updateAllUI(status);
            } catch(e) {}
        }

        async function loadInitialConfig() {
            try {
                const config = await apiCall('/api/config');
                const autoSleepConfig = config.autoSleep;
                const targetServerConfig = config.targetServer;

                document.getElementById('idleEnableCheckbox').checked = autoSleepConfig.enabled;
                document.getElementById('gpuEnableCheckbox').checked = autoSleepConfig.monitorGpu;
                document.getElementById('timeoutSlider').value = autoSleepConfig.minutes;
                document.getElementById('timeoutValue').textContent = `${autoSleepConfig.minutes} minutes`;

                document.getElementById('configIP').textContent = targetServerConfig.ip;
                document.getElementById('configMAC').textContent = targetServerConfig.mac;
                document.getElementById('configSSH').textContent = targetServerConfig.sshPort;
                document.getElementById('configHTTP').textContent = targetServerConfig.httpPort;
                document.getElementById('serverIP').textContent = targetServerConfig.ip;

                toggleIdleOptions();
            } catch (error) { /* error is already logged */ }
        }

        function setupEventListeners() {
            document.getElementById('idleEnableCheckbox').addEventListener('change', () => { toggleIdleOptions(); updateAutoSleepSettings(); });
            document.getElementById('gpuEnableCheckbox').addEventListener('change', updateAutoSleepSettings);
            const slider = document.getElementById('timeoutSlider');
            slider.addEventListener('input', () => { document.getElementById('timeoutValue').textContent = `${slider.value} minutes`; });
            slider.addEventListener('change', updateAutoSleepSettings);
        }

        function toggleIdleOptions() { document.getElementById('idleOptionsContainer').classList.toggle('hidden', !document.getElementById('idleEnableCheckbox').checked); }

        async function updateAutoSleepSettings() {
            const config = {
                enabled: document.getElementById('idleEnableCheckbox').checked,
                monitorGpu: document.getElementById('gpuEnableCheckbox').checked,
                minutes: parseInt(document.getElementById('timeoutSlider').value)
            };
            try {
                 await apiCall('/api/config/autosleep', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(config) });
                 addLog('info', 'Auto-sleep settings updated.');
            } catch(e) {}
        }

        function setupSocketListeners() {
            socket.on('connect', () => addLog('info', 'Connected to SPARK server.'));
            socket.on('disconnect', () => addLog('warn', 'Disconnected from SPARK server.'));
            socket.on('statusUpdate', (status) => updateAllUI(status));
            socket.on('error', (error) => addLog('error', `SPARK Error: ${error.message}`));
        }
        
        function updateAllUI(status) {
            const indicator = document.getElementById('statusIndicator');
            indicator.className = `status-indicator status-${status.isOnline ? 'online' : 'offline'}`;
            document.getElementById('serverStatus').textContent = status.isOnline ? 'Online' : 'Offline';
            document.getElementById('lastSeen').textContent = status.isOnline ? new Date(status.lastSeen).toLocaleString() : 'N/A';
            document.getElementById('responseTime').textContent = status.performance.responseTime ? `${status.performance.responseTime}ms` : '-';
            
            updateServiceStatus('pingStatus', status.services.ping);
            updateServiceStatus('sshStatus', status.services.ssh);
            updateServiceStatus('httpStatus', status.services.http);
            updateServiceStatus('targetHttpStatus', status.services.targetHttp);

            updatePerformanceMetric('cpuUsage', 'cpuBar', status.performance.cpuUsage);
            updatePerformanceMetric('memoryUsage', 'memoryBar', status.performance.memoryUsage);
            updatePerformanceMetric('diskUsage', 'diskBar', status.performance.diskUsage);
            updatePerformanceMetric('gpuUsage', 'gpuBar', status.performance.gpuUsage);

            updateAutoSleepUI(status.autoSleep);
        }

        function updateServiceStatus(elementId, isOnline) {
            const el = document.getElementById(elementId);
            if(el){
                el.className = `service-badge badge-${isOnline ? 'online' : 'offline'}`;
                el.textContent = isOnline ? 'Online' : 'Offline';
            }
        }

        function updatePerformanceMetric(valueId, barId, value) {
            const valueEl = document.getElementById(valueId);
            const barEl = document.getElementById(barId);
            if(valueEl && barEl){
                if (typeof value === 'number' && !isNaN(value)) {
                    valueEl.textContent = `${value.toFixed(1)}%`;
                    barEl.style.width = `${Math.min(value, 100)}%`;
                } else {
                    valueEl.textContent = 'N/A';
                    barEl.style.width = '0%';
                }
            }
        }

        function updateAutoSleepUI(autoSleep) {
            const container = document.getElementById('idleCountdownContainer');
            if (autoSleep.enabled && autoSleep.isIdle && autoSleep.timeUntilSleep !== null) {
                const minutes = Math.floor(autoSleep.timeUntilSleep / 60000);
                const seconds = Math.floor((autoSleep.timeUntilSleep % 60000) / 1000).toString().padStart(2, '0');
                container.textContent = `Sleeping in ${minutes}:${seconds}`;
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }
        
        function showActionMessage(message, type) {
            const el = document.getElementById('actionMessage');
            el.textContent = message;
            el.style.display = 'block';
            el.style.color = type === 'error' ? '#742a2a' : '#22543d';
            el.style.backgroundColor = type === 'error' ? '#fed7d7' : '#c6f6d5';
            setTimeout(() => { el.style.display = 'none'; }, 5000);
        }

        let logs = [];
        function addLog(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            logs.unshift({ timestamp, level, message });
            if (logs.length > 50) logs.pop();
            const logsContainer = document.getElementById('logsContainer');
            logsContainer.innerHTML = logs.map(log => `
                <div class="log-entry">
                    <span style="color: #68d391">[${log.timestamp}]</span>
                    <span style="font-weight: bold; color: ${level === 'info' ? '#63b3ed' : level === 'warn' ? '#f6e05e' : '#fc8181'}">[${level.toUpperCase()}]</span>
                    ${log.message}
                </div>
            `).join('');
        }
    </script>
</body>
</html>
